package eu.first.sentify.companypage.twittersentiment;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.URL;
import java.net.URLConnection;
import java.util.Hashtable;
import java.util.Map;

import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.json.simple.JSONObject;
import org.json.simple.JSONValue;


public class TwitterSentiment extends HttpServlet{

	Hashtable<String, String> cache = new Hashtable<String, String>();
	String serviceURL = "http://first.ijs.si/TwitterSentiVisService/GetSentimentTimeline.aspx";
	
	
	public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException {
		String paramString = formatParams(request.getParameterMap());
		String mimeType = getServletContext().getMimeType("test.js");
		response.setContentType(mimeType);

		//check caching
		if (cache.containsKey(paramString) == false) {
			URL twitterService = new URL(serviceURL + formatParams(request.getParameterMap()));
			URLConnection yc = twitterService.openConnection();
	        BufferedReader in = new BufferedReader(new InputStreamReader(yc.getInputStream()));
	        
	        String inputLine;
	        StringBuilder jsonResponse = new StringBuilder();
	        while ((inputLine = in.readLine()) != null) 
	            jsonResponse.append(inputLine);
	        in.close();
			
	        //JSONObject obj= (JSONObject) JSONValue.parse(jsonResponse.toString());
	        String newJSON = jsonResponse.toString();
	        
	        //old code:
//	        String newJSON = jsonResponse.toString()
//	        		.replace("d:", "\"d\":")
//	        		.replace("v:", "\"v\":")
//	        		.replace("nn:", "\"nn\":")
//	        		.replace("pn:", "\"pn\":")
//	        		.replace("p:", "\"p\":")
//	        		.replace("n:", "\"n\":");
	        
	        cache.put(paramString, newJSON);
	        
			PrintWriter out = response.getWriter();
		    out.println(newJSON);
	        
		} else {
			String jsonResponse = cache.get(paramString);
			
			PrintWriter out = response.getWriter();
		    //out.println("function(" + jsonResponse.toString() + ");");
			out.println(jsonResponse.toString());
		}
		

	    
//		String debug = "[{\"d\":\"2012-03-01\",\"v\":{\"p\":861,\"n\":163,\"pn\":431,\"nn\":315}},{\"d\":\"2012-03-02\",\"v\":{\"p\":860,\"n\":166,\"pn\":247,\"nn\":241}},{\"d\":\"2012-03-03\",\"v\":{\"p\":264,\"n\":30,\"pn\":80,\"nn\":61}},{\"d\":\"2012-03-04\",\"v\":{\"p\":237,\"n\":45,\"pn\":91,\"nn\":61}},{\"d\":\"2012-03-05\",\"v\":{\"p\":1290,\"n\":258,\"pn\":394,\"nn\":441}},{\"d\":\"2012-03-06\",\"v\":{\"p\":1592,\"n\":298,\"pn\":451,\"nn\":486}},{\"d\":\"2012-03-07\",\"v\":{\"p\":2079,\"n\":463,\"pn\":617,\"nn\":676}},{\"d\":\"2012-03-08\",\"v\":{\"p\":1025,\"n\":187,\"pn\":356,\"nn\":323}},{\"d\":\"2012-03-09\",\"v\":{\"p\":832,\"n\":142,\"pn\":304,\"nn\":250}},{\"d\":\"2012-03-10\",\"v\":{\"p\":250,\"n\":19,\"pn\":69,\"nn\":218}},{\"d\":\"2012-03-11\",\"v\":{\"p\":248,\"n\":23,\"pn\":138,\"nn\":128}},{\"d\":\"2012-03-12\",\"v\":{\"p\":841,\"n\":351,\"pn\":315,\"nn\":270}},{\"d\":\"2012-03-13\",\"v\":{\"p\":1414,\"n\":270,\"pn\":414,\"nn\":417}},{\"d\":\"2012-03-14\",\"v\":{\"p\":1176,\"n\":275,\"pn\":361,\"nn\":492}},{\"d\":\"2012-03-15\",\"v\":{\"p\":1208,\"n\":279,\"pn\":436,\"nn\":402}},{\"d\":\"2012-03-16\",\"v\":{\"p\":1450,\"n\":237,\"pn\":481,\"nn\":467}},{\"d\":\"2012-03-17\",\"v\":{\"p\":262,\"n\":48,\"pn\":141,\"nn\":92}},{\"d\":\"2012-03-18\",\"v\":{\"p\":620,\"n\":67,\"pn\":222,\"nn\":133}},{\"d\":\"2012-03-19\",\"v\":{\"p\":3442,\"n\":527,\"pn\":1142,\"nn\":951}},{\"d\":\"2012-03-20\",\"v\":{\"p\":1532,\"n\":313,\"pn\":531,\"nn\":505}},{\"d\":\"2012-03-21\",\"v\":{\"p\":953,\"n\":163,\"pn\":297,\"nn\":233}},{\"d\":\"2012-03-22\",\"v\":{\"p\":758,\"n\":225,\"pn\":294,\"nn\":282}},{\"d\":\"2012-03-23\",\"v\":{\"p\":707,\"n\":283,\"pn\":330,\"nn\":398}},{\"d\":\"2012-03-24\",\"v\":{\"p\":527,\"n\":42,\"pn\":71,\"nn\":90}},{\"d\":\"2012-03-25\",\"v\":{\"p\":336,\"n\":26,\"pn\":72,\"nn\":49}},{\"d\":\"2012-03-26\",\"v\":{\"p\":993,\"n\":164,\"pn\":345,\"nn\":418}},{\"d\":\"2012-03-27\",\"v\":{\"p\":973,\"n\":136,\"pn\":350,\"nn\":288}},{\"d\":\"2012-03-28\",\"v\":{\"p\":970,\"n\":138,\"pn\":369,\"nn\":263}},{\"d\":\"2012-03-29\",\"v\":{\"p\":847,\"n\":216,\"pn\":324,\"nn\":307}},{\"d\":\"2012-03-30\",\"v\":{\"p\":992,\"n\":192,\"pn\":345,\"nn\":299}},{\"d\":\"2012-03-31\",\"v\":{\"p\":223,\"n\":22,\"pn\":43,\"nn\":55}},{\"d\":\"2012-04-01\",\"v\":{\"p\":211,\"n\":33,\"pn\":68,\"nn\":53}},{\"d\":\"2012-04-02\",\"v\":{\"p\":1076,\"n\":159,\"pn\":322,\"nn\":274}},{\"d\":\"2012-04-03\",\"v\":{\"p\":1076,\"n\":148,\"pn\":358,\"nn\":316}},{\"d\":\"2012-04-04\",\"v\":{\"p\":1015,\"n\":182,\"pn\":411,\"nn\":331}},{\"d\":\"2012-04-05\",\"v\":{\"p\":1076,\"n\":231,\"pn\":314,\"nn\":330}},{\"d\":\"2012-04-06\",\"v\":{\"p\":459,\"n\":116,\"pn\":110,\"nn\":76}},{\"d\":\"2012-04-07\",\"v\":{\"p\":228,\"n\":43,\"pn\":131,\"nn\":62}},{\"d\":\"2012-04-08\",\"v\":{\"p\":193,\"n\":22,\"pn\":80,\"nn\":41}},{\"d\":\"2012-04-09\",\"v\":{\"p\":945,\"n\":196,\"pn\":369,\"nn\":312}},{\"d\":\"2012-04-10\",\"v\":{\"p\":1148,\"n\":168,\"pn\":405,\"nn\":292}},{\"d\":\"2012-04-11\",\"v\":{\"p\":1121,\"n\":146,\"pn\":267,\"nn\":295}},{\"d\":\"2012-04-12\",\"v\":{\"p\":970,\"n\":145,\"pn\":288,\"nn\":299}},{\"d\":\"2012-04-13\",\"v\":{\"p\":809,\"n\":176,\"pn\":557,\"nn\":250}},{\"d\":\"2012-04-14\",\"v\":{\"p\":262,\"n\":34,\"pn\":83,\"nn\":58}},{\"d\":\"2012-04-15\",\"v\":{\"p\":140,\"n\":26,\"pn\":81,\"nn\":67}},{\"d\":\"2012-04-16\",\"v\":{\"p\":1064,\"n\":287,\"pn\":546,\"nn\":542}},{\"d\":\"2012-04-17\",\"v\":{\"p\":1555,\"n\":322,\"pn\":607,\"nn\":541}},{\"d\":\"2012-04-18\",\"v\":{\"p\":1196,\"n\":290,\"pn\":481,\"nn\":363}},{\"d\":\"2012-04-19\",\"v\":{\"p\":889,\"n\":249,\"pn\":347,\"nn\":353}},{\"d\":\"2012-04-20\",\"v\":{\"p\":1253,\"n\":274,\"pn\":424,\"nn\":398}},{\"d\":\"2012-04-21\",\"v\":{\"p\":504,\"n\":40,\"pn\":256,\"nn\":129}},{\"d\":\"2012-04-22\",\"v\":{\"p\":386,\"n\":63,\"pn\":181,\"nn\":99}},{\"d\":\"2012-04-23\",\"v\":{\"p\":1228,\"n\":179,\"pn\":396,\"nn\":376}},{\"d\":\"2012-04-24\",\"v\":{\"p\":1842,\"n\":444,\"pn\":613,\"nn\":592}},{\"d\":\"2012-04-25\",\"v\":{\"p\":1688,\"n\":297,\"pn\":562,\"nn\":507}},{\"d\":\"2012-04-26\",\"v\":{\"p\":1047,\"n\":181,\"pn\":342,\"nn\":269}},{\"d\":\"2012-04-27\",\"v\":{\"p\":852,\"n\":171,\"pn\":350,\"nn\":271}},{\"d\":\"2012-04-28\",\"v\":{\"p\":358,\"n\":52,\"pn\":110,\"nn\":71}},{\"d\":\"2012-04-29\",\"v\":{\"p\":339,\"n\":35,\"pn\":121,\"nn\":79}},{\"d\":\"2012-04-30\",\"v\":{\"p\":980,\"n\":215,\"pn\":390,\"nn\":390}},{\"d\":\"2012-05-01\",\"v\":{\"p\":976,\"n\":196,\"pn\":370,\"nn\":299}},{\"d\":\"2012-05-02\",\"v\":{\"p\":968,\"n\":146,\"pn\":319,\"nn\":227}},{\"d\":\"2012-05-03\",\"v\":{\"p\":768,\"n\":201,\"pn\":285,\"nn\":312}},{\"d\":\"2012-05-04\",\"v\":{\"p\":832,\"n\":209,\"pn\":274,\"nn\":291}},{\"d\":\"2012-05-05\",\"v\":{\"p\":300,\"n\":32,\"pn\":62,\"nn\":46}},{\"d\":\"2012-05-06\",\"v\":{\"p\":344,\"n\":33,\"pn\":74,\"nn\":66}},{\"d\":\"2012-05-07\",\"v\":{\"p\":844,\"n\":98,\"pn\":233,\"nn\":225}},{\"d\":\"2012-05-08\",\"v\":{\"p\":687,\"n\":149,\"pn\":250,\"nn\":236}},{\"d\":\"2012-05-09\",\"v\":{\"p\":709,\"n\":115,\"pn\":252,\"nn\":237}},{\"d\":\"2012-05-10\",\"v\":{\"p\":654,\"n\":111,\"pn\":194,\"nn\":212}},{\"d\":\"2012-05-11\",\"v\":{\"p\":743,\"n\":103,\"pn\":319,\"nn\":228}},{\"d\":\"2012-05-12\",\"v\":{\"p\":379,\"n\":13,\"pn\":50,\"nn\":106}},{\"d\":\"2012-05-13\",\"v\":{\"p\":218,\"n\":11,\"pn\":33,\"nn\":72}},{\"d\":\"2012-05-14\",\"v\":{\"p\":829,\"n\":128,\"pn\":259,\"nn\":244}},{\"d\":\"2012-05-15\",\"v\":{\"p\":989,\"n\":224,\"pn\":397,\"nn\":293}},{\"d\":\"2012-05-16\",\"v\":{\"p\":1183,\"n\":299,\"pn\":481,\"nn\":393}},{\"d\":\"2012-05-17\",\"v\":{\"p\":1063,\"n\":205,\"pn\":418,\"nn\":308}},{\"d\":\"2012-05-18\",\"v\":{\"p\":939,\"n\":191,\"pn\":319,\"nn\":369}},{\"d\":\"2012-05-19\",\"v\":{\"p\":191,\"n\":22,\"pn\":67,\"nn\":60}},{\"d\":\"2012-05-20\",\"v\":{\"p\":156,\"n\":17,\"pn\":71,\"nn\":44}},{\"d\":\"2012-05-21\",\"v\":{\"p\":909,\"n\":138,\"pn\":557,\"nn\":227}},{\"d\":\"2012-05-22\",\"v\":{\"p\":1274,\"n\":168,\"pn\":438,\"nn\":326}},{\"d\":\"2012-05-23\",\"v\":{\"p\":1378,\"n\":199,\"pn\":429,\"nn\":325}},{\"d\":\"2012-05-24\",\"v\":{\"p\":1021,\"n\":176,\"pn\":299,\"nn\":326}},{\"d\":\"2012-05-25\",\"v\":{\"p\":935,\"n\":112,\"pn\":244,\"nn\":225}},{\"d\":\"2012-05-26\",\"v\":{\"p\":180,\"n\":27,\"pn\":65,\"nn\":53}},{\"d\":\"2012-05-27\",\"v\":{\"p\":125,\"n\":31,\"pn\":38,\"nn\":16}},{\"d\":\"2012-05-28\",\"v\":{\"p\":224,\"n\":16,\"pn\":74,\"nn\":48}},{\"d\":\"2012-05-29\",\"v\":{\"p\":941,\"n\":127,\"pn\":249,\"nn\":217}},{\"d\":\"2012-05-30\",\"v\":{\"p\":1453,\"n\":232,\"pn\":445,\"nn\":479}},{\"d\":\"2012-05-31\",\"v\":{\"p\":930,\"n\":135,\"pn\":267,\"nn\":300}}]";
//
//		PrintWriter out = response.getWriter();
//	    out.println(debug);

	    
	}
	
	private String formatParams(Map pm) {
		StringBuilder result = new StringBuilder();
		result.append("?");
		for (Object s : pm.keySet()) {
			String key = (String) s;
			String value = ((String[]) pm.get(s))[0];
			result.append(key + "=" + value + "&");
		}
		
		return result.toString();
	}
}
